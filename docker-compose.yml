version: "3.8"

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: receipt-intelligence
    restart: unless-stopped
    ports:
      - "${STREAMLIT_SERVER_PORT:-8501}:8501"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - PINECONE_INDEX_NAME=${PINECONE_INDEX_NAME:-receipt-index}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - RECEIPT_DATA_PATH=/app/data/receipt_samples_100
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_ENABLE_CORS=false
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
      - PYTHONUNBUFFERED=1
    volumes:
      - receipt_data:/app/data
      - ./src:/app/src:ro  # Mount source for development (read-only)
    networks:
      - receipt_network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8501')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: Indexer service for one-time data ingestion
  indexer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: receipt-indexer
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - PINECONE_INDEX_NAME=${PINECONE_INDEX_NAME:-receipt-index}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - RECEIPT_DATA_PATH=/app/data/receipt_samples_100
      - PYTHONUNBUFFERED=1
    volumes:
      - receipt_data:/app/data
    command: >
      python -c "
      import sys
      import os
      from pathlib import Path
      
      # Ensure project root is in path
      sys.path.insert(0, os.getcwd())
      
      from src.vectorstore.vector_manager import VectorManager
      from src.parsers.receipt_parser import ReceiptParser
      from src.chunking.receipt_chunker import ReceiptChunker

      print('Initializing components...')
      try:
          vector_manager = VectorManager()
          parser = ReceiptParser()
          chunker = ReceiptChunker()
      except Exception as e:
          print(f'Initialization failed: {e}')
          sys.exit(1)

      # Check if index has data
      try:
          stats = vector_manager.get_index_stats()
          if stats.get('total_vector_count', 0) > 0:
              print(f'Index already contains {stats[\"total_vector_count\"]} vectors. Skipping indexing.')
              sys.exit(0)
      except Exception as e:
          print(f'Failed to check index stats: {e}')

      print('Loading and processing receipt data...')
      data_path = Path(os.getenv('RECEIPT_DATA_PATH', '/app/data/receipt_samples_100'))
      if not data_path.exists():
          print(f'Data path NOT FOUND: {data_path}')
          sys.exit(1)

      receipt_files = sorted(data_path.glob('receipt_*.txt'))
      print(f'Found {len(receipt_files)} receipt files')

      all_chunks = []
      for file_path in receipt_files:
          try:
              content = file_path.read_text(encoding='utf-8')
              receipt = parser.parse_receipt(content, filename=file_path.name)
              chunks = chunker.chunk_receipt(receipt)
              all_chunks.extend(chunks)
          except Exception as e:
              print(f'Error processing {file_path.name}: {e}')
              continue

      print(f'Created {len(all_chunks)} chunks from {len(receipt_files)} receipts')

      if all_chunks:
          print('Indexing chunks...')
          indexed = vector_manager.index_chunks(all_chunks, batch_size=50)
          print(f'Successfully indexed {indexed} chunks')
      else:
          print('No chunks to index')
      "
    depends_on: []
    profiles:
      - indexer
    networks:
      - receipt_network

volumes:
  receipt_data:
    driver: local

networks:
  receipt_network:
    driver: bridge
